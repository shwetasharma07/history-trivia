<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results - BrainRace</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body class="results-page">
    <div class="results-container">
        <div class="results-card bounce-in">
            <!-- Header with emoji and title -->
            <div class="results-header">
                <div class="results-emoji" id="results-emoji">&#x1F389;</div>
                <h1 class="results-title" id="results-title">Great Job!</h1>
                <p class="results-subtitle" id="results-subtitle">You've completed the quiz!</p>
            </div>

            <!-- Main Score Display -->
            <div class="score-showcase">
                <div class="score-ring" id="score-ring">
                    <svg class="score-svg" viewBox="0 0 120 120">
                        <circle class="score-bg-circle" cx="60" cy="60" r="54"/>
                        <circle class="score-progress-circle" id="score-circle-progress" cx="60" cy="60" r="54"/>
                    </svg>
                    <div class="score-center">
                        <span class="score-number" id="final-score">0</span>
                        <span class="score-separator">/</span>
                        <span class="score-total" id="total-questions">10</span>
                    </div>
                </div>
                <div class="score-percentage" id="score-percentage">0%</div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-icon">&#x2705;</div>
                    <div class="stat-card-value" id="stat-correct">0</div>
                    <div class="stat-card-label">Correct</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">&#x274C;</div>
                    <div class="stat-card-value" id="stat-wrong">0</div>
                    <div class="stat-card-label">Wrong</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">&#x1F525;</div>
                    <div class="stat-card-value" id="stat-streak">0</div>
                    <div class="stat-card-label">Best Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">&#x2764;&#xFE0F;</div>
                    <div class="stat-card-value" id="stat-lives">0</div>
                    <div class="stat-card-label">Lives Left</div>
                </div>
            </div>

            <!-- Performance Message -->
            <div class="performance-message" id="performance-message">
                <p id="score-message">You're a history superstar!</p>
            </div>

            <!-- Save Score Form -->
            <div class="save-score-section" id="save-score-section">
                <h3>Save Your Score</h3>
                <form id="save-score-form" class="save-form">
                    <input
                        type="text"
                        id="player-name"
                        placeholder="Enter your name"
                        maxlength="20"
                        required
                        class="name-input"
                        autocomplete="off"
                    >
                    <button type="submit" class="save-button">
                        Save to Leaderboard
                    </button>
                </form>
            </div>

            <!-- Save Success Message -->
            <div class="save-success hidden" id="save-success">
                <span class="success-icon">&#x2705;</span>
                <span class="success-text" id="success-text">Score saved!</span>
            </div>

            <!-- Action Buttons -->
            <div class="results-actions">
                <button id="quick-rematch" class="action-button rematch" title="Play again with same settings (R)">
                    <span>&#x26A1;</span>
                    <span>Quick Rematch</span>
                </button>
                <a href="/" class="action-button play-again">
                    <span>&#x2699;</span>
                    <span>New Game</span>
                </a>
                <a href="/leaderboard" class="action-button view-leaderboard">
                    <span>&#x1F3C6;</span>
                    <span>Leaderboard</span>
                </a>
                <a href="/" class="action-button go-home">
                    <span>&#x1F3E0;</span>
                    <span>Home</span>
                </a>
            </div>
        </div>
    </div>

    <script>
        // Get score data from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const isMultiplayer = urlParams.get('mode') === 'multiplayer';

        if (isMultiplayer) {
            // Handle multiplayer results
            const results = JSON.parse(sessionStorage.getItem('multiplayerResults') || '[]');
            const totalQuestions = parseInt(sessionStorage.getItem('totalQuestions')) || 10;
            const winner = results[0];

            // Hide solo-specific elements
            document.querySelector('.score-showcase').style.display = 'none';
            document.querySelector('.stats-grid').style.display = 'none';
            document.getElementById('save-score-section').style.display = 'none';

            // Update header
            document.getElementById('results-emoji').innerHTML = '&#x1F3C6;';
            document.getElementById('results-title').textContent = winner ? `${winner.name} Wins!` : 'Game Over!';
            document.getElementById('results-subtitle').textContent = 'Final Standings';

            // Create multiplayer leaderboard
            const performanceDiv = document.getElementById('performance-message');
            performanceDiv.innerHTML = `
                <div class="multiplayer-results">
                    <div class="mp-standings">
                        ${results.map((player, idx) => `
                            <div class="mp-player-row ${idx === 0 ? 'winner' : ''}">
                                <span class="mp-rank">${idx === 0 ? '&#x1F947;' : idx === 1 ? '&#x1F948;' : idx === 2 ? '&#x1F949;' : idx + 1}</span>
                                <span class="mp-name">${player.name}</span>
                                <div class="mp-stats">
                                    <span class="mp-score">${player.score} pts</span>
                                    <span class="mp-correct">${player.correct}/${Math.ceil(totalQuestions / results.length)} correct</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Confetti for winner
            setTimeout(() => {
                confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 } });
            }, 500);
        } else {
            // Solo mode
            const score = parseInt(urlParams.get('score')) || 0;
            const total = parseInt(urlParams.get('total')) || 10;
            const bestStreak = parseInt(urlParams.get('streak')) || 0;
            const livesLeft = parseInt(urlParams.get('lives')) || 0;
            const isPerfect = urlParams.get('perfect') === '1';

            // Pre-fill username from sessionStorage
            const savedUsername = sessionStorage.getItem('username');
            if (savedUsername) {
                document.getElementById('player-name').value = savedUsername;
            }

            initSoloResults(score, total, bestStreak, livesLeft, isPerfect);
        }

        function initSoloResults(score, total, bestStreak, livesLeft, isPerfect = false) {
            const percentage = Math.min(100, Math.round((score / (total * 20)) * 100)); // Normalize to percentage

            // Update display elements
            document.getElementById('final-score').textContent = score;
            document.getElementById('total-questions').textContent = total * 20; // Max possible score
            document.getElementById('score-percentage').textContent = percentage + '%';

            // Update stats - for points-based scoring
            const correctCount = Math.round(score / 15); // Estimate based on avg points
            document.getElementById('stat-correct').textContent = correctCount;
            document.getElementById('stat-wrong').textContent = Math.max(0, total - correctCount);
            document.getElementById('stat-streak').textContent = bestStreak;
            document.getElementById('stat-lives').textContent = livesLeft;

            // Animate the score ring
            const progressCircle = document.getElementById('score-circle-progress');
            const circumference = 2 * Math.PI * 54;
            progressCircle.style.strokeDasharray = circumference;
            progressCircle.style.strokeDashoffset = circumference;

            setTimeout(() => {
                const offset = circumference - (percentage / 100) * circumference;
                progressCircle.style.strokeDashoffset = offset;
            }, 100);

            // Set message and emoji based on score
            const resultsTitle = document.getElementById('results-title');
            const resultsSubtitle = document.getElementById('results-subtitle');
            const resultsEmoji = document.getElementById('results-emoji');
            const scoreMessage = document.getElementById('score-message');
            const scoreRing = document.getElementById('score-ring');

            if (isPerfect) {
                // Special handling for perfect round
                resultsTitle.textContent = 'PERFECT!';
                resultsSubtitle.textContent = 'Flawless Victory! +50 Bonus!';
                resultsEmoji.innerHTML = '&#x1F31F;';
                scoreMessage.textContent = "Not a single mistake! You're a true genius!";
                scoreRing.classList.add('perfect');
                // Extra celebration for perfect round
                setTimeout(() => {
                    confetti({ particleCount: 300, spread: 120, origin: { y: 0.6 } });
                    setTimeout(() => confetti({ particleCount: 150, angle: 60, spread: 80, origin: { x: 0 } }), 250);
                    setTimeout(() => confetti({ particleCount: 150, angle: 120, spread: 80, origin: { x: 1 } }), 400);
                }, 300);
            } else if (percentage >= 90) {
                resultsTitle.textContent = 'AMAZING!';
                resultsSubtitle.textContent = 'Outstanding performance!';
                resultsEmoji.innerHTML = '&#x1F451;';
                scoreMessage.textContent = "You're a true knowledge champion!";
                scoreRing.classList.add('perfect');
                setTimeout(() => {
                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                    setTimeout(() => confetti({ particleCount: 100, spread: 120, origin: { y: 0.5 } }), 300);
                }, 500);
            } else if (percentage >= 70) {
                resultsTitle.textContent = 'Excellent!';
                resultsSubtitle.textContent = 'Great job!';
                resultsEmoji.innerHTML = '&#x1F31F;';
                scoreMessage.textContent = "You really know your stuff!";
                scoreRing.classList.add('great');
                setTimeout(() => confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }), 500);
            } else if (percentage >= 50) {
                resultsTitle.textContent = 'Good Job!';
                resultsSubtitle.textContent = 'Well done!';
                resultsEmoji.innerHTML = '&#x1F389;';
                scoreMessage.textContent = "You're on your way to becoming an expert!";
                scoreRing.classList.add('good');
                setTimeout(() => confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } }), 500);
            } else if (percentage >= 30) {
                resultsTitle.textContent = 'Nice Try!';
                resultsSubtitle.textContent = 'Keep practicing!';
                resultsEmoji.innerHTML = '&#x1F44D;';
                scoreMessage.textContent = "Keep learning and you'll be a pro in no time!";
                scoreRing.classList.add('okay');
            } else {
                resultsTitle.textContent = 'Keep Learning!';
                resultsSubtitle.textContent = "Don't give up!";
                resultsEmoji.innerHTML = '&#x1F4DA;';
                scoreMessage.textContent = "Every expert was once a beginner. Try again!";
                scoreRing.classList.add('learning');
            }

            // Handle save score form
            document.getElementById('save-score-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const playerName = document.getElementById('player-name').value.trim();

                if (!playerName) return;

                const button = e.target.querySelector('button');
                button.disabled = true;
                button.textContent = 'Saving...';

                try {
                    const response = await fetch(`/api/save-score?player_name=${encodeURIComponent(playerName)}&score=${score}&total_questions=${total}`, {
                        method: 'POST'
                    });
                    const data = await response.json();

                    document.getElementById('save-score-section').classList.add('hidden');
                    const successDiv = document.getElementById('save-success');
                    successDiv.classList.remove('hidden');

                    if (data.made_leaderboard) {
                        document.getElementById('success-text').innerHTML =
                            `You made the leaderboard at <strong>#${data.rank}</strong>! &#x1F3C6;`;
                        confetti({ particleCount: 50, spread: 60 });
                    } else {
                        document.getElementById('success-text').textContent = 'Score saved successfully!';
                    }
                } catch (error) {
                    console.error('Error saving score:', error);
                    button.disabled = false;
                    button.textContent = 'Save to Leaderboard';
                    alert('Could not save score. Please try again.');
                }
            });
        }

        // Quick Rematch - Play again with same settings
        document.getElementById('quick-rematch').addEventListener('click', () => {
            // Settings are already in sessionStorage from the previous game
            // Just redirect to play page
            window.location.href = '/play';
        });

        // Keyboard shortcut: R for rematch
        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'r' && !e.target.matches('input, textarea')) {
                window.location.href = '/play';
            }
        });
    </script>
</body>
</html>
